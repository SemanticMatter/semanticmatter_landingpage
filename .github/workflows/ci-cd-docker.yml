name: CI/CD - Docker

on:
  # Trigger the workflow for all PRs
  pull_request:

  # Make the workflow callable (from cd_release.yml workflow)
  workflow_call:
    inputs:
      source-ref:
        description: 'The source branch or tag to build from.'
        required: true
        default: 'main'
        type: 'string'
      version:
        description: 'The version to tag the Docker image with.'
        required: false
        type: 'string'
      image-name:
        description: 'The name of the Docker image to build.'
        required: false
        default: 'semanticmatter-landingpage'
        type: 'string'
    secrets:
      GITLAB_REGISTRY_USER:
        description: 'The username for the Container Registry.'
        required: true
      GITLAB_REGISTRY_PASSWORD:
        description: 'The password (or Personal Access Token) for the Container Registry.'
        required: true
      DOCKER_USERNAME:
        description: 'The username for Docker Hub Container Registry.'
        required: true
      DOCKER_PASSWORD:
        description: 'The password (or Personal Access Token) for Docker Hub Container Registry.'
        required: true

env:
  IMAGE_ROOT_GITHUB: ghcr.io/semanticmatter
  IMAGE_ROOT_GITLAB: ${{ vars.SINTEF_GITLAB_REGISTRY_URL }}/semanticmatter/dataspaces

  # Avoid uploading build records as a GitHub Artifact
  DOCKER_BUILD_RECORD_UPLOAD: false

jobs:
  docker:
    name: Docker
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.source-ref || github.ref }}
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt update && sudo apt install -qqy jq

      - name: Retrieve metadata information
        id: metadata
        run: |
          # If version input is provided, use it; otherwise, extract it from package.json
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="$(jq -r '.version' package.json)"
          fi

          TIME_NOW=$(date --utc +%FT%TZ)

          echo "Metadata information:"
          echo "  version=${VERSION}"
          echo "  time_now=${TIME_NOW}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "time_now=${TIME_NOW}" >> $GITHUB_OUTPUT

      - name: Docker metadata
        id: docker_metadata
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_ROOT_GITHUB }}/${{ inputs.image-name || vars.IMAGE_NAME }}
            ${{ env.IMAGE_ROOT_GITLAB }}/${{ inputs.image-name || vars.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.metadata.outputs.version }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.created=${{ steps.metadata.outputs.time_now }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.title=Semantic Matter - Corporate SPA
            org.opencontainers.image.description=Enterprise-grade marketing and product showcase for Semantic Matter, built with Next.js 14, App Router, Tailwind CSS, and Framer Motion.
            org.opencontainers.image.vendor=SemanticMatter
            org.opencontainers.image.authors=Thomas Fj√¶stad Hagelien (thomas.f.hagelien@sintef.no), Casper Welzel Andersen (casper.w.andersen@sintef.no), Treesa Rose Joseph (treesa.joseph@sintef.no)
            org.opencontainers.image.licenses=MIT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub Container Registry
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Only login to Publishing Container Registries if called from `cd-release.yml` workflow
      # (i.e., not on pull requests)

      - name: Login to GitLab Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.SINTEF_GITLAB_REGISTRY_URL }}
          username: ${{ secrets.GITLAB_REGISTRY_USER }}
          password: ${{ secrets.GITLAB_REGISTRY_PASSWORD }}

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: ${{ runner.temp }}/.buildx-cache
          key: ${{ github.repository }}-${{ runner.os }}-sm-landingpage-${{ github.sha }}
          restore-keys: |
            ${{ github.repository }}-${{ runner.os }}-sm-landingpage-

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          # Push only if called from `cd-release.yml` workflow (i.e., not on pull requests)
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.docker_metadata.outputs.tags }}
          labels: ${{ steps.docker_metadata.outputs.labels }}
          cache-from: type=local,src=${{ runner.temp }}/.buildx-cache
          cache-to: type=local,dest=${{ runner.temp }}/.buildx-cache-new,mode=max
          provenance: false

      # Temp fix
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
      - name: Move cache
        run: |
          rm -rf ${{ runner.temp }}/.buildx-cache
          mv ${{ runner.temp }}/.buildx-cache-new ${{ runner.temp }}/.buildx-cache
